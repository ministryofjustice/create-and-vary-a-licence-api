[![repo standards badge](https://img.shields.io/endpoint?labelColor=231f20&color=005ea5&style=flat&label=MoJ%20Compliant&url=https%3A%2F%2Foperations-engineering-reports-prod.cloud-platform.service.justice.gov.uk%2Fapi%2Fv1%2Fcompliant_public_repositories%2Fendpoint%2Fcreate-and-vary-a-licence-api&logo=data:image/png;base64,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)](https://operations-engineering-reports-prod.cloud-platform.service.justice.gov.uk/public-report/create-and-vary-a-licence-api)
[![CircleCI](https://circleci.com/gh/ministryofjustice/create-and-vary-a-licence-api/tree/main.svg?style=svg)](https://circleci.com/gh/ministryofjustice/create-and-vary-a-licence-api)
[![codecov](https://codecov.io/gh/ministryofjustice/create-and-vary-a-licence-api/branch/main/graph/badge.svg?token=G7EZ0S2D92)](https://codecov.io/gh/ministryofjustice/create-and-vary-a-licence-api)
[![API docs](https://img.shields.io/badge/API_docs_-view-85EA2D.svg?logo=swagger)](https://create-and-vary-a-licence-api-dev.hmpps.service.justice.gov.uk/swagger-ui/index.html)
[![Event docs](https://img.shields.io/badge/Event_docs-view-85EA2D.svg)](https://studio.asyncapi.com/?url=https://raw.githubusercontent.com/ministryofjustice/create-and-vary-a-licence-api/main/async-api.yml)

# create-and-vary-a-licence-api

This service provides access to data stored in the licences database via API endpoints.
The main client is the create-and-vary-a-licence (UI) service.
It is built as docker image and deployed to the MOJ Cloud Platform.

## Building the project

Tools required:

* SDKMAN
* Kotlin
* docker
* docker-compose

### Install SDKMAN

Install SDKMAN from  https://sdkman.io/ and run the following

```shell
sdk env
```

This will install the required JDK.

### Install gradle

`./gradlew`

`./gradlew clean build`

## Running the service

There is a script to help, which sets local profiles, port and DB connection properties to the
values required.

```shell
./run-local.sh`
```

To run start up the application without pulling / restarting local containers:

```shell
./run-local.sh --skip-docker
```

### Running application inside the IDE

This option is needed if you want to trace or debug your code!
If you want to run the spring application in side your IDE,
follow the following steps:

* Run in terminal

```Shell
./set-vars-to-env-file.sh
```

* Then run in terminal

```Shell
docker compose up
```

* Add the following to your IJ IDE Run/Debug configurations "Environment variables"

```
/Users/<<YOUR-USER-DIR>>/env-config/after.env
```

<em>The IDE behaves a bit odd here, try and selected the folder and file do not type it in!</em>

## Running the unit tests

Unit tests mock all external dependencies and can be run with no dependent containers.

`./gradlew test`

## Running the integration tests

Integration tests use Wiremock to stub any API calls required, and use a local H2 database
that is seeded with data specific to each test suite.

`./gradlew integrationTest`

## Pre-commit hooks

To install the pre-commit hooks run `./gradlew installLocalGitHook`

This will install hooks for:

* ktlint linter
* Detekt static code analysis

### Linting

To locate any linting issues

`./gradlew ktlintcheck`

To apply some fixes following linting

`./gradlew ktlintformat`

### Static Code Analysis

We use a tool called Detekt locally to provide code smell
analysis for the project. A baseline currently exists with all the existing
issues at `detekt-baseline.yml`.

To generate/re-generate the baseline:

`./gradlew detektBaseline`

To run Detekt:

`./gradlew detekt`

Detekt provides some helpful reports in HTML as well which can be opened in any
browser. These are available at `build/reports/detekt`.

## Dependencies

List the dependency tree

`./gradlew dependencies`

Pull latest dependencies according to the `build.gradle.kts` file

`./gradlew dependencyUpdates`

## OWASP vulnerability scanning

`./gradlew dependencyCheckAnalyze`

## Kotlin JPA specification

This project makes use of `https://github.com/consoleau/kotlin-jpa-specification-dsl` to wrap the JPA specification
in fluent style Kotlin and make it much more readable when creating the JPA Specifications used in selecting licences
by criteria.

As this dependency is not available in the Maven central repository yet, and JCenter has closed its
services now, we have imported the single-file directly and kept the licence notification in the comments.
We can wait to see whether the dependency will soon become available in Maven central and import it from there.

## Connecting to licences-db

The licences-db container is the database that is used by the API. Once this is available, a final extra task would be
to manage the database locally using a SQL database manager application software of your choice (DBeaver, DataGrip etc).

For the purposes of this, we will be using DBeaver. Using Homebrew, install the community version of DBeaver

```shell
brew install --cask dbeaver-community
```

Once installed, open up DBeaver and connect to a database using the Database Navigator and the plug type icon to connect
to a database.

![database-connection.png](images%2Fdatabase-connection.png)

From the options, select PostgreSQL and click Next.

![postgres-data-source.png](images%2Fpostgres-data-source.png)

Some of the parameters should already be populated but you need to amend the following:

![postgres-configuration.png](images%2Fpostgres-configuration.png)

Once set up, you should see the following tree structure which will allow you to access the various tables in the CVL
database locally.

![posttgres-example.png](images%2Fposttgres-example.png)
